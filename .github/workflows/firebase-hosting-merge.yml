# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on merge
on:
  push:
    branches:
      - main

jobs:
  # CI job for testing, linting, and checking coverage
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: "20"
      - name: Install dependencies
        run: npm ci
      - name: Run lint
        run: npm run lint
      - name: Run tests with coverage
        run: |
          npm test -- --coverage
      - name: Check test coverage
        run: |
          # Check if Jest coverage is above 75%
          COVERAGE=$(grep -oP 'All files.*\K\d+(?=%)' coverage/lcov-report/index.html)
          echo "Test coverage is ${COVERAGE}%"
          if [ "$COVERAGE" -lt 75 ]; then
            echo "Test coverage is below 75%. Aborting deployment."
            exit 1
          fi

  # Build and deploy job
  build_and_deploy:
    runs-on: ubuntu-latest
    needs: ci # Ensure the CI job runs successfully before deploying
    if: success() # Only run this job if the previous job (ci) succeeded
    steps:
      - uses: actions/checkout@v2
      - run: npm ci && npm run build
      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_REACTAPP_F85C5 }}
          channelId: live
          projectId: reactapp-f85c5
